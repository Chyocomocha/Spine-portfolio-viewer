<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spine Portfolio Viewer</title>
<script src="https://unpkg.com/@esotericsoftware/spine-player@4.2/dist/iife/spine-player.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@esotericsoftware/spine-player@4.2/dist/spine-player.css">
<style>
    /* 배경 투명 */
    body { margin: 0; padding: 0; background: transparent; color: #eee; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
    #player-container { width: 100%; height: 75vh; margin-bottom: 10px; }

    .control-panel { width: 95%; max-width: 800px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
    .track-group { background: rgba(0, 0, 0, 0.6); padding: 15px; border-radius: 8px; flex: 1; min-width: 250px; }
    .group-title { font-weight: bold; margin-bottom: 10px; color: #ccc; text-transform: uppercase; font-size: 0.85em; border-bottom: 1px solid #555; padding-bottom: 5px; }
    .btn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 6px; }
    
    button { padding: 8px 5px; cursor: pointer; background: #444; color: white; border: 1px solid #555; border-radius: 4px; font-size: 0.85em; transition: 0.2s; }
    button:hover { background: #666; transform: translateY(-2px); border-color: #888; }
    
    .btn-idle { background: #2b5c8a; border-color: #3e7cb3; }
    .btn-action { background: #8a2b2b; border-color: #b33e3e; }
</style>
</head>
<body>

<div id="player-container"></div>

<div class="control-panel">
    <div class="track-group">
        <div class="group-title">Base Actions</div>
        <div class="btn-grid">
            <button class="btn-idle" onclick="resetToIdle()">Return Idle</button>
            <button class="btn-action" onclick="playAction('Action_001')">Action 1</button>
            <button class="btn-action" onclick="playAction('Action_002')">Action 2</button>
            <button class="btn-action" onclick="playAction('Signature')">Signature</button>
        </div>
    </div>
    <div class="track-group">
        <div class="group-title">Emotions</div>
        <div class="btn-grid">
            <button onclick="playEmo('Emo_Idle', true)">Emo Idle</button>
            <button onclick="playEmo('Emo_001', false)">Emo 1</button>
            <button onclick="playEmo('Emo_002', false)">Emo 2</button>
            <button onclick="playEmo('Emo_003', false)">Emo 3</button>
            <button onclick="playEmo('Emo_004', false)">Emo 4</button>
            <button onclick="playEmo('Emo_005', false)">Emo 5</button>
            <button onclick="playEmo('Emo_006', false)">Emo 6</button>
        </div>
    </div>
</div>

<script>
    let player;
    // 부드러운 전환 시간 (0.2초)
    const MIX_DURATION = 0.2;
    // 타이머 관리용 변수
    let faceTimer = null;

    const CONFIG = {
        skelUrl: "./LD_Narin.skel.bytes", 
        atlasUrl: "./LD_Narin.atlas.txt",
        baseIdle: "Idle",        
        emoIdle: "Emo_Idle"      
    };

    new spine.SpinePlayer("player-container", {
        skelUrl: CONFIG.skelUrl,
        atlasUrl: CONFIG.atlasUrl,
        showControls: false,          
        backgroundColor: "#00000000", 
        alpha: true,                  
        premultipliedAlpha: true,

        success: function (p) {
            player = p;
            // 기본 믹스 설정
            player.animationState.data.defaultMix = MIX_DURATION;
            console.log("로딩 성공 (Start Hold & End Sync 적용)");
            resetToIdle(); 
        },
        error: function (p, e) {
            console.error("Error:", e);
        }
    });

    // --- 기능 함수 ---
    function resetToIdle() {
        if (!player) return;
        // 기존 예약된 타이머가 있다면 취소 (광클 방지)
        if (faceTimer) clearTimeout(faceTimer);
        
        player.animationState.setAnimation(0, CONFIG.baseIdle, true);
        player.animationState.setAnimation(1, CONFIG.emoIdle, true);
    }

    function playAction(animName) {
        if (!player) return;
        
        // 광클 시 이전 타이머 취소
        if (faceTimer) clearTimeout(faceTimer);

        // 1. 몸 동작 실행 (Track 0)
        // 몸은 0.2초 동안 서서히 변합니다.
        const entry = player.animationState.setAnimation(0, animName, false);
        const actionDuration = entry.animation.duration;
        
        // 몸 동작 끝나면 Idle 예약
        player.animationState.addAnimation(0, CONFIG.baseIdle, true, 0);

        // 2. 얼굴 표정 처리 (Track 1)
        
        // ★★★ 핵심 수정 1: 들어갈 때 (Start) ★★★
        // "바로 표정을 지우지 말고, 0.1초만 기다려!"
        // 몸이 어느 정도 변한 뒤에 표정을 바꿔야 '기본 얼굴'이 안 보입니다.
        faceTimer = setTimeout(() => {
            // 0.1초 뒤에 현재 표정을 부드럽게(0.2s) 지웁니다.
            // 이때는 이미 몸이 액션 동작을 하고 있어서 '액션 표정'이 드러납니다.
            player.animationState.setEmptyAnimation(1, MIX_DURATION);
            
            // ★★★ 핵심 수정 2: 나올 때 (End) ★★★
            // 아까 성공했던 로직: 액션 끝나기 0.2초 전에 미리 복귀 예약
            // (이미 0.1초가 지났으므로 계산에서 고려)
            let returnDelay = actionDuration - MIX_DURATION - 0.1;
            if (returnDelay < 0) returnDelay = 0;

            player.animationState.addAnimation(1, CONFIG.emoIdle, true, returnDelay);
            
        }, 100); // 100ms = 0.1초 대기
    }

    function playEmo(animName, loop) {
        if (!player) return;
        if (faceTimer) clearTimeout(faceTimer);
        player.animationState.setAnimation(1, animName, loop);
    }
</script>

</body>
</html>